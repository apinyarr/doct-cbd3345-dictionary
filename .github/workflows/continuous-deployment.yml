---
name: Continuous Deployment (CD)
on:
  push:
    tags:
      - 'uat-release-*'
      - 'prd-release-*'

jobs:  
  uat-deployment:   # This job is triggered by 'uat-release-*' tags.
    name: Deploy Simple Dictionary App in UAT K8s Cluster
    if: startsWith(github.ref, 'refs/tags/uat-release-')
    runs-on: k8s-deployer

    steps:
      - name: Checkout Source Code
        uses: actions/checkout@v4

      - name: Verify K8s Cluster Information
        run: |
          KUBECONFIG=~/.kube/docker_desktop_k8s_config kubectl config get-clusters
          KUBECONFIG=~/.kube/docker_desktop_k8s_config kubectl cluster-info

      - name: Ensure UAT namespace has been created
        env:
          UAT_NAMESPACE: dictionary-namespace
        run: |
          KUBECONFIG=~/.kube/docker_desktop_k8s_config kubectl get ns | grep ${{ env.UAT_NAMESPACE }} && echo ${{ env.UAT_NAMESPACE }} is existed || KUBECONFIG=~/.kube/docker_desktop_k8s_config kubectl apply -f k8s/manifests/namespace.yaml